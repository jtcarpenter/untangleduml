<?php
class test_diagram_model extends CodeIgniterUnitTestCase{
    /**
    * test_diagram_model
    *
    * This test runs unit tests against diagram_model
    * Tests run against the real application database
    * Re-initialises database to a consistent state
    *
    * @author	Jason Carpenter
    */
    
    private $mock_diagram;
    private $observer;
    private $decoded_observer;
    private $file_path;
    private $untangled;
    private $updated_untangled;
    private $decoded_untangled;
    private $updated_decoded_untangled;
    private $user_id;
    private $untangled_path;
    private $mock_untangled;

    //application UML diagrams
    private $untangled_analysis = '{"title":"untangled analysis","id":null,"version":0,"vertices":[{"names":["Reader"],"attributes":[],"methods":[],"x":300,"y":76},{"names":["Writer"],"attributes":[],"methods":[],"x":387,"y":75},{"names":["Assimilator"],"attributes":[],"methods":[],"x":116,"y":235},{"names":["Highlighter"],"attributes":[],"methods":[],"x":571,"y":199},{"names":["Painter"],"attributes":[],"methods":[],"x":576,"y":266},{"names":["Dispatcher"],"attributes":[],"methods":[],"x":329,"y":235},{"names":["Graph"],"attributes":[],"methods":[],"x":387,"y":387},{"names":["Vertex"],"attributes":[],"methods":[],"x":595,"y":454},{"names":["Edge"],"attributes":[],"methods":[],"x":569,"y":318},{"names":["Language"],"attributes":[],"methods":[],"x":263,"y":389}],"edges":[{"left":"Dispatcher","right":"Reader","type":"bi","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"Writer","type":"bi","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"Assimilator","type":"bi","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"Painter","type":"bi","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"Graph","type":"bi","leftMult":"1","rightMult":"1","role":""},{"left":"Graph","right":"Vertex","type":"bi","leftMult":"1","rightMult":"0..*","role":""},{"left":"Graph","right":"Edge","type":"bi","leftMult":"1","rightMult":"0..*","role":""},{"left":"Dispatcher","right":"Language","type":"bi","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"Highlighter","type":"bi","leftMult":"1","rightMult":"1","role":""},{"left":"Vertex","right":"Edge","type":"bi","leftMult":"1","rightMult":"0..*","role":""}],"matrix":[[1,0,0,0,0,-1,0,0,0,0],[0,1,0,0,0,-1,0,0,0,0],[0,0,1,0,0,-1,0,0,0,0],[0,0,0,0,1,-1,0,0,0,0],[0,0,0,0,0,-1,1,0,0,0],[0,0,0,0,0,0,-1,1,0,0],[0,0,0,0,0,0,-1,0,1,0],[0,0,0,0,0,-1,0,0,0,1],[0,0,0,1,0,-1,0,0,0,0],[0,0,0,0,0,0,0,-1,1,0]],"fontSize":18,"shared":true}';
    private $server_analysis = '{"title":"server analysis","id":null,"version":0,"vertices":[{"names":["<<controller>>","Front_controller"],"attributes":[],"methods":[],"x":420,"y":326},{"names":["<<controller>>","Auth"],"attributes":[],"methods":[],"x":425,"y":507},{"names":["<<controller>>","Accounts"],"attributes":[],"methods":[],"x":121,"y":326},{"names":["<<controller>>","Documentation"],"attributes":[],"methods":[],"x":422,"y":161},{"names":["<<controller>>","Editor"],"attributes":[],"methods":[],"x":708,"y":326},{"names":["<<controller>>","Sharing"],"attributes":[],"methods":[],"x":220,"y":668},{"names":["<<view>>","Auth_view"],"attributes":[],"methods":[],"x":483,"y":423},{"names":["<<view>>","Account_view"],"attributes":[],"methods":[],"x":123,"y":256},{"names":["<<view>>","Documentation_view"],"attributes":[],"methods":[],"x":404,"y":95},{"names":["<<view>>","Editor_view"],"attributes":[],"methods":[],"x":717,"y":257},{"names":["<<view>>","Sharing_view"],"attributes":[],"methods":[],"x":223,"y":603},{"names":["<<model>>","Tank_auth"],"attributes":[],"methods":[],"x":529,"y":668},{"names":["<<model>>","Diagram_model"],"attributes":[],"methods":[],"x":703,"y":396},{"names":["<<model>>","Sharing_model"],"attributes":[],"methods":[],"x":89,"y":668}],"edges":[{"left":"Front_controller","right":"Auth","type":"bi","leftMult":"","rightMult":"","role":""},{"left":"Front_controller","right":"Accounts","type":"bi","leftMult":"","rightMult":"","role":""},{"left":"Front_controller","right":"Documentation","type":"bi","leftMult":"","rightMult":"","role":""},{"left":"Front_controller","right":"Editor","type":"bi","leftMult":"","rightMult":"","role":""},{"left":"Front_controller","right":"Sharing","type":"bi","leftMult":"","rightMult":"","role":""},{"left":"Auth","right":"Auth_view","type":"bi","leftMult":"","rightMult":"","role":""},{"left":"Auth","right":"Tank_auth","type":"bi","leftMult":"","rightMult":"","role":""},{"left":"Accounts","right":"Tank_auth","type":"bi","leftMult":"","rightMult":"","role":""},{"left":"Accounts","right":"Account_view","type":"bi","leftMult":"","rightMult":"","role":""},{"left":"Documentation","right":"Documentation_view","type":"bi","leftMult":"","rightMult":"","role":""},{"left":"Editor","right":"Editor_view","type":"bi","leftMult":"","rightMult":"","role":""},{"left":"Editor","right":"Tank_auth","type":"bi","leftMult":"","rightMult":"","role":""},{"left":"Editor","right":"Diagram_model","type":"bi","leftMult":"","rightMult":"","role":""},{"left":"Sharing","right":"Sharing_view","type":"bi","leftMult":"","rightMult":"","role":""},{"left":"Sharing","right":"Sharing_model","type":"bi","leftMult":"","rightMult":"","role":""},{"left":"Sharing","right":"Tank_auth","type":"bi","leftMult":"","rightMult":"","role":""}],"matrix":[[-1,1,0,0,0,0,0,0,0,0,0,0,0,0],[-1,0,1,0,0,0,0,0,0,0,0,0,0,0],[-1,0,0,1,0,0,0,0,0,0,0,0,0,0],[-1,0,0,0,1,0,0,0,0,0,0,0,0,0],[-1,0,0,0,0,1,0,0,0,0,0,0,0,0],[0,-1,0,0,0,0,1,0,0,0,0,0,0,0],[0,-1,0,0,0,0,0,0,0,0,0,1,0,0],[0,0,-1,0,0,0,0,0,0,0,0,1,0,0],[0,0,-1,0,0,0,0,1,0,0,0,0,0,0],[0,0,0,-1,0,0,0,0,1,0,0,0,0,0],[0,0,0,0,-1,0,0,0,0,1,0,0,0,0],[0,0,0,0,-1,0,0,0,0,0,0,1,0,0],[0,0,0,0,-1,0,0,0,0,0,0,0,1,0],[0,0,0,0,0,-1,0,0,0,0,1,0,0,0],[0,0,0,0,0,-1,0,0,0,0,0,0,0,1],[0,0,0,0,0,-1,0,0,0,0,0,1,0,0]],"fontSize":14,"shared":true}';
    private $untangled_design = '{"title":"untangled design","id":null,"version":0,"vertices":[{"names":["<<Object literal>>","Reader"],"attributes":["lang:Language","graph:Graph"],"methods":["read():Graph","getElements()","setCoords(Object)","getRelationships()","addToMatrix(Object)","matchPhrase(String,RegExp):Array","matchWord(String,RegExp):String","matchWords(String,RegExp):Array"],"x":118,"y":98},{"names":["<<Object literal>>","Writer"],"attributes":["graph:Graph"],"methods":["write(Graph)","addTitle()","parseGraph()","writeElements(Array)","writeRelationships(Array,Array)","writeRelationship(Edge):String","writeToEditor(String,Boolean)"],"x":684,"y":30},{"names":["<<Object literal>>","Assimilator"],"attributes":["newGraph:Graph","oldGraph:Graph","assimGraph:Graph"],"methods":["assim(Graph,Graph):Graph","updateVertices(Array,Array):Array"],"x":408,"y":31},{"names":["<<Object literal>>","Highlighter"],"attributes":["html:String","txt:String","elements:Array","names:Array","language:Language"],"methods":["highlight()","cleanFalseMathces():String","stripOldHighlights()","getNames()","decodeHtmlSpecialChars():String","encodeHtmlSpecialChars():String","highlightInvalid(String):String","highlightvalid(String):String","highlightStereotypes(String):String","highlightEndWordMatches(String):String","highlightNames(String):String","highlightIds():String","highlightReserved(String):String"],"x":138,"y":735},{"names":["<<Object literal>>","Painter"],"attributes":["graph:Graph","isa:Array","hasa:Array","aggr:Array","comp:Array","boxes:Array","x:Number","y:Number","defaultX:Number","defaultY:Number","tallest:Number","drawingAreaPadding:Number"],"methods":["paint(Graph)","setupJSPlumb()","setCoords(Vertex,Object)","createBoxes()","dashed(Array)","getOverlay(Edge):Array","getConnection(Array):Object","getRecursiveConnection(Array):Object","connect(DOMElement,DOMElement,Object)","plumbBoxes()","addDragToUnconnected()"],"x":679,"y":279},{"names":["<<Object literal>>","Dispatcher"],"attributes":["graph:Graph","spinner:Object","spinnerOpts:Object","target:DOM","baseURL:String"],"methods":["init()","closeDown()","addEventListeners()","checkTitleLength(Event)","removeEventListeners()","setFontBtns()","fontHuge()","fontBig()","fontMedium()","fontSmall()","update()","open(String)","close()","clearDefault(DOM,String)","fresh()","print()","confirmDelete()","account()","deleteDiagram()","load()","loadShared(String)","sharing()","unshare(String)","reject(String)","liveSearch(String)","share(String)","loadGraph(Number,Boolean)","save()","docs()","async(String,String,string,Function,String)"],"x":392,"y":282},{"names":["<<JS Class>>","Graph"],"attributes":["title:String","id:Number","version:Number","vertices:Array","edges:Array","matrix:Array","font-size:Number","shared:Boolean"],"methods":[],"x":750,"y":577},{"names":["<<JS Class>>","Vertex"],"attributes":["names:Array","attributes:Array","methods:Array","x:Number","y:Number"],"methods":[],"x":696,"y":847},{"names":["<<JS Class>>","Edge"],"attributes":["left:String","right:String","type:String","leftMult:String","rightMult:String","role:String"],"methods":[],"x":819,"y":844},{"names":["<<Object literal>>","Language"],"attributes":["ELEMENT_PHRASE:RegExp","RELATIONSHIP_PHRASE:RegExp","STEREOTYPE_WORD:RegExp","NAME_WORD:RegExp","ATTRIBUTE_WORD:RegExp","METHOD_WORD:RegExp","END_WORD:RegExp","MULT_WORD:RegExp","END_NAME_WORD:RegExp","REL_TYPE_WORD:RegExp","REL_TYPE_NAMES_WORD:RegExp","REL_TYPE_ROLE_WORD:RegExp","REL_ID_WORD:RegExp","RESERVED_WORD:RegExp","ID_WORD:RegExp","SPECIAL_CHAR:RegExp"],"methods":[],"x":142,"y":376}],"edges":[{"left":"Dispatcher","right":"Reader","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"Writer","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"Assimilator","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"Painter","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"Graph","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Graph","right":"Vertex","type":"hasa","leftMult":"1","rightMult":"0..*","role":""},{"left":"Graph","right":"Edge","type":"hasa","leftMult":"1","rightMult":"0..*","role":""},{"left":"Dispatcher","right":"Highlighter","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Reader","right":"Language","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Highlighter","right":"Language","type":"hasa","leftMult":"1","rightMult":"1","role":""}],"matrix":[[1,0,0,0,0,-1,0,0,0,0],[0,1,0,0,0,-1,0,0,0,0],[0,0,1,0,0,-1,0,0,0,0],[0,0,0,0,1,-1,0,0,0,0],[0,0,0,0,0,-1,1,0,0,0],[0,0,0,0,0,0,-1,1,0,0],[0,0,0,0,0,0,-1,0,1,0],[0,0,0,1,0,-1,0,0,0,0],[-1,0,0,0,0,0,0,0,0,1],[0,0,0,-1,0,0,0,0,0,1]],"fontSize":10,"shared":true}';
    private $editor_controller = '{"title":"editor controller","id":null,"version":0,"vertices":[{"names":["<<controller>>","CI_Controller"],"attributes":[],"methods":[],"x":324,"y":61},{"names":["<<controller>>","Editor"],"attributes":["-data:Array"],"methods":["+__construct()","+index():HTML","+save():JSON","+diagrams():HTML","+shared_diagrams():HTML","+load(String):JSON","+delete(String):HTML"],"x":284,"y":176},{"names":["<<model>>","CI_Model"],"attributes":[],"methods":[],"x":717,"y":57},{"names":["<<model>>","Diagram_model"],"attributes":["-file_path:String"],"methods":["+__construct()","+insert_diagram(int,String,int,Boolean):int","+update_diagram(int,int,String,int,Boolean):Boolean","+write_diagram(int,String)","+diagram_exists(int):int","+save_diagram(Object):int","+get_user_diagrams():Object","+get_diagam_str(int):JSON","+get_diagram(int):Object","+get_shared_diagrams(int):Object","+delete_diagram(int):Boolean"],"x":589,"y":165},{"names":["<<HTML>>","editor_view"],"attributes":[],"methods":[],"x":9,"y":295},{"names":["<<HTML>>","unavailable_view"],"attributes":[],"methods":[],"x":10,"y":189},{"names":["<<library>>","Tank_auth"],"attributes":[],"methods":["+is_logged_in():Boolean","+get_username():String","+get_user_id():String"],"x":402,"y":563},{"names":["<<model>>","Users"],"attributes":[],"methods":["+get_user_by_username(String):Array"],"x":247,"y":681},{"names":["<<helper>>","Url"],"attributes":[],"methods":["+base_url():String","+site_url():String"],"x":161,"y":558},{"names":["<<helper>>","Db"],"attributes":[],"methods":["+query(String,Array):Object","+insertID():String"],"x":638,"y":526},{"names":["<<helper>>","File"],"attributes":[],"methods":["+read_file():String","+write_file(String,String)"],"x":858,"y":519}],"edges":[{"left":"Editor","right":"CI_Controller","type":"isa","leftMult":"","rightMult":"","role":""},{"left":"Diagram_model","right":"CI_Model","type":"isa","leftMult":"","rightMult":"","role":""},{"left":"Diagram_model","right":"File","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Editor","right":"Diagram_model","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Editor","right":"Tank_auth","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Editor","right":"editor_view","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Editor","right":"unavailable_view","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Editor","right":"Url","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Diagram_model","right":"Db","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Editor","right":"Users","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Diagram_model","right":"Tank_auth","type":"hasa","leftMult":"1","rightMult":"1","role":""}],"matrix":[[1,-1,0,0,0,0,0,0,0,0,0],[0,0,1,-1,0,0,0,0,0,0,0],[0,0,0,-1,0,0,0,0,0,0,1],[0,-1,0,1,0,0,0,0,0,0,0],[0,-1,0,0,0,0,1,0,0,0,0],[0,-1,0,0,1,0,0,0,0,0,0],[0,-1,0,0,0,1,0,0,0,0,0],[0,-1,0,0,0,0,0,0,1,0,0],[0,0,0,-1,0,0,0,0,0,1,0],[0,-1,0,0,0,0,0,1,0,0,0],[0,0,0,-1,0,0,1,0,0,0,0]],"fontSize":14,"shared":true}';
    private $sharing_controller = '{"title":"sharing controller","id":null,"version":0,"vertices":[{"names":["<<controller>>","CI_Controller"],"attributes":[],"methods":[],"x":294,"y":22},{"names":["<<model>>","CI_Model"],"attributes":[],"methods":[],"x":691,"y":12},{"names":["<<controller>>","Sharing"],"attributes":["-data:Array"],"methods":["+index():HTML","+user():HTML","+share():HTML","+unshare():HTML","+reject():HTML"],"x":282,"y":155},{"names":["<<model>>","Sharing_model"],"attributes":["-file_path:String"],"methods":["+__construct()","+add_sharing(int):Boolean","+remove_sharing(int):Boolean","+reject_sharing(int):Boolean","+get_shared_users():Object","+get_sharers():Object"],"x":616,"y":146},{"names":["<<HTML>>","unavailable_view"],"attributes":[],"methods":[],"x":24,"y":116},{"names":["<<HTML>>","sharing_view"],"attributes":[],"methods":[],"x":38,"y":328},{"names":["<<helper>>","Form"],"attributes":[],"methods":["+form_open(String,Array):String","+form_input(Array):String","+form_submit(Array):String","+form_close():String"],"x":387,"y":622},{"names":["<<model>>","Users"],"attributes":[],"methods":["+get_user_by_id(String,Boolean):Array","+search_users():String","+get_user_by_username(String):Array"],"x":27,"y":506},{"names":["<<library>>","Tank_auth"],"attributes":[],"methods":["+is_logged_in():Boolean","+get_username():String","+get_user_id():String"],"x":592,"y":471},{"names":["<<helper>>","Db"],"attributes":[],"methods":["+query(String,Array):Array"],"x":751,"y":660}],"edges":[{"left":"Sharing","right":"CI_Controller","type":"isa","leftMult":"","rightMult":"","role":""},{"left":"Sharing_model","right":"CI_Model","type":"isa","leftMult":"","rightMult":"","role":""},{"left":"Sharing","right":"Sharing_model","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Sharing","right":"unavailable_view","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Sharing","right":"sharing_view","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Sharing","right":"Form","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Sharing","right":"Users","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Sharing","right":"Tank_auth","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Sharing_model","right":"Tank_auth","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Sharing_model","right":"Db","type":"hasa","leftMult":"1","rightMult":"1","role":""}],"matrix":[[1,0,-1,0,0,0,0,0,0,0],[0,1,0,-1,0,0,0,0,0,0],[0,0,-1,1,0,0,0,0,0,0],[0,0,-1,0,1,0,0,0,0,0],[0,0,-1,0,0,1,0,0,0,0],[0,0,-1,0,0,0,1,0,0,0],[0,0,-1,0,0,0,0,1,0,0],[0,0,-1,0,0,0,0,0,1,0],[0,0,0,-1,0,0,0,0,1,0],[0,0,0,-1,0,0,0,0,0,1]],"fontSize":18,"shared":true}';
    private $accounts_controller = '{"title":"accounts controller","id":null,"version":0,"vertices":[{"names":["<<controller>>","CI_Controller"],"attributes":[],"methods":[],"x":295,"y":30},{"names":["<<controller>>","Accounts"],"attributes":["-data:Array"],"methods":["+index():HTML"],"x":295,"y":146},{"names":["<<helper>>","Url"],"attributes":[],"methods":["+base_url():String"],"x":570,"y":270},{"names":["<<library>>","Tank_auth"],"attributes":[],"methods":["+is_logged_in():Boolean"],"x":555,"y":57},{"names":["<<HTML>>","unavailable_view"],"attributes":[],"methods":[],"x":23,"y":67},{"names":["<<HTML>>","account_view"],"attributes":[],"methods":[],"x":32,"y":288}],"edges":[{"left":"Accounts","right":"CI_Controller","type":"isa","leftMult":"","rightMult":"","role":""},{"left":"Accounts","right":"Url","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Accounts","right":"Tank_auth","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Accounts","right":"unavailable_view","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Accounts","right":"account_view","type":"hasa","leftMult":"1","rightMult":"1","role":""}],"matrix":[[1,-1,0,0,0,0],[0,-1,1,0,0,0],[0,-1,0,1,0,0],[0,-1,0,0,1,0],[0,-1,0,0,0,1]],"fontSize":18,"shared":true}';
    private $documentation_controller = '{"title":"documentation controller","id":null,"version":0,"vertices":[{"names":["<<controller>>","CI_Controller"],"attributes":[],"methods":[],"x":423,"y":24},{"names":["<<controller>>","Documentation"],"attributes":[],"methods":["+index():HTML"],"x":422,"y":160},{"names":["<<HTML>>","documentation_view"],"attributes":[],"methods":[],"x":40,"y":172}],"edges":[{"left":"Documentation","right":"CI_Controller","type":"isa","leftMult":"","rightMult":"","role":""},{"left":"Documentation","right":"documentation_view","type":"hasa","leftMult":"1","rightMult":"1","role":""}],"matrix":[[1,-1,0],[0,-1,1]],"fontSize":18,"shared":true}';

    public function __construct(){
        parent::__construct();

        $this->UnitTestCase('Diagram Model');
        $this->_ci->load->model('diagram_model');
        $this->_ci->load->helper('file');
        $this->file_path = 'graphs/';

        $this->_ci->load->library('form_validation');
	$this->_ci->load->library('tank_auth');
        $this->_ci->load->library('security');
	$this->_ci->lang->load('tank_auth');

        $this->user_id = $this->_ci->tank_auth->get_user_id();
    }

    /**
     * setUp
     *
     * Runs before every test
     */
    public function setUp(){
        error_reporting(0);

        $this->mock_diagram = 'I am a diagram';
        $this->observer = '{"title":"observer","id":null,"version":0,"shared":true,"vertices":[{"names":["<<interface>>","Subject"],"attributes":[],"methods":["+attach()","+detach()","+notify()"],"x":10,"y":10},{"names":["<<interface>>","Observer"],"attributes":[],"methods":["+update()"],"x":40,"y":40},{"names":["ConcreteSubject"],"attributes":["-subjectState"],"methods":[],"x":70,"y":70},{"names":["ConcreteObserver"],"attributes":["-observerState"],"methods":["+update()"],"x":100,"y":100}],"edges":[{"left":"Subject","right":"Observer","type":"hasa","leftMult":"","rightMult":"","role":"notifies"},{"left":"ConcreteObserver","right":"ConcreteSubject","type":"hasa","leftMult":"","rightMult":"","role":"observes"},{"left":"ConcreteSubject","right":"Subject","type":"isa","leftMult":"","rightMult":"","role":""},{"left":"ConcreteObserver","right":"Observer","type":"isa","leftMult":"","rightMult":"","role":""}],"matrix":[[-1,1,0,0],[0,0,1,-1],[1,0,-1,0],[0,1,0,-1]],"fontSize":18}';
        $this->decoded_observer = json_decode($this->observer);

        //simplified version of application diagram for testing
        $this->untangled = '{"title":"untangled","id":null,"version":0,"shared":true,"vertices":[{"names":["Reader"],"attributes":["lang:Language","graph:Graph","offset:10"],"methods":["read(g)","getText()","getElements()","getRelationships()","addToMatrix()","matchPhrase()","matchWord()","matchWords()"],"x":10,"y":10},{"names":["Writer"],"attributes":["graph:Graph"],"methods":["write(g)","parseGraph()","writeElements(v)","writeRels(edges,matrix)","writeRel(edge)","writeToEditor(param)","clearEditor()"],"x":40,"y":40},{"names":["Assimilator"],"attributes":["newG:Graph","oldGraph:Graph","assimGraph:Graph"],"methods":["assim(oldGraph,newGraph)","updateVertices(oldVs,newVs)"],"x":70,"y":70},{"names":["Highlighter"],"attributes":["names:[]","language:Language"],"methods":["highlight()","stripOldHighlights()","highlightIdentifiers()","getNames()","highlightNames()"],"x":100,"y":100},{"names":["Painter"],"attributes":["graph:Graph","isa:[]","hasa:[]","aggr:[]","comp:[]","boxes:[]"],"methods":["paint(g)","setupJSPlumb()","createBoxes()","getOverlay(edge)","getConnection(overlay)","getRecursiveConnection(overlay)","connect(srcDiv,tgtDiv,connection)","plumbBoxes()"],"x":130,"y":130},{"names":["Dispatcher"],"attributes":["graph:Graph"],"methods":["init()","saveGraph()","loadGraph()","printGraph()","exportGraph()","updateGraph()","updateGraphCoords()","newDiagram()","share()","createAccount()","toggleAuthorship()"],"x":160,"y":160},{"names":["Graph"],"attributes":["vertices:[]","edges:[]","matrix:[]","font-size:number","padding:number"],"methods":[],"x":190,"y":190},{"names":["Vertex"],"attributes":["x:number","y:number","stereotype:string","name:string","attributes:[]","methods:[]"],"methods":[],"x":220,"y":220},{"names":["Edge"],"attributes":["left:string","right:string","type:string","leftMult:string","rightMult:string","role:string"],"methods":[],"x":250,"y":250},{"names":["Language"],"attributes":["ELEMENT_PHRASE:RegExp","RELATIONSHIP_PHRASE:RegExp","STEREOTYPE_WORD:RegExp","NAME_WORD:RegExp","ATTRIBUTE_WORD:RegExp","METHOD_WORD:RegExp","END_WORD:RegExp","MULT_WORD:RegExp","END_NAME_WORD:RegExp","REL_TYPE_WORD:RegExp","REL_TYPE_NAMES_WORD:RegExp"],"methods":[],"x":280,"y":280},{"names":["<<DOM>>","text_area"],"attributes":[],"methods":[],"x":310,"y":310},{"names":["<<DOM>>","drawing_panel"],"attributes":[],"methods":[],"x":340,"y":340},{"names":["<<server>>","Server"],"attributes":[],"methods":[],"x":370,"y":370}],"edges":[{"left":"Dispatcher","right":"Reader","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"Writer","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"Assimilator","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"Painter","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"Graph","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Graph","right":"Vertex","type":"hasa","leftMult":"1","rightMult":"0..*","role":""},{"left":"Graph","right":"Edge","type":"hasa","leftMult":"1","rightMult":"0..*","role":""},{"left":"Dispatcher","right":"Language","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"text_area","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"drawing_panel","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"Server","type":"hasa","leftMult":"1","rightMult":"1","role":""}],"matrix":[[1,0,0,0,0,-1,0,0,0,0,0,0,0],[0,1,0,0,0,-1,0,0,0,0,0,0,0],[0,0,1,0,0,-1,0,0,0,0,0,0,0],[0,0,0,0,1,-1,0,0,0,0,0,0,0],[0,0,0,0,0,-1,1,0,0,0,0,0,0],[0,0,0,0,0,0,-1,1,0,0,0,0,0],[0,0,0,0,0,0,-1,0,1,0,0,0,0],[0,0,0,0,0,-1,0,0,0,1,0,0,0],[0,0,0,0,0,-1,0,0,0,0,1,0,0],[0,0,0,0,0,-1,0,0,0,0,0,1,0],[0,0,0,0,0,-1,0,0,0,0,0,0,1]],"fontSize":18}';
        $this->inserted_untangled = '{"title":"untangled","id":1,"version":1,"shared":true,"vertices":[{"names":["Reader"],"attributes":["lang:Language","graph:Graph","offset:10"],"methods":["read(g)","getText()","getElements()","getRelationships()","addToMatrix()","matchPhrase()","matchWord()","matchWords()"],"x":10,"y":10},{"names":["Writer"],"attributes":["graph:Graph"],"methods":["write(g)","parseGraph()","writeElements(v)","writeRels(edges,matrix)","writeRel(edge)","writeToEditor(param)","clearEditor()"],"x":40,"y":40},{"names":["Assimilator"],"attributes":["newG:Graph","oldGraph:Graph","assimGraph:Graph"],"methods":["assim(oldGraph,newGraph)","updateVertices(oldVs,newVs)"],"x":70,"y":70},{"names":["Highlighter"],"attributes":["names:[]","language:Language"],"methods":["highlight()","stripOldHighlights()","highlightIdentifiers()","getNames()","highlightNames()"],"x":100,"y":100},{"names":["Painter"],"attributes":["graph:Graph","isa:[]","hasa:[]","aggr:[]","comp:[]","boxes:[]"],"methods":["paint(g)","setupJSPlumb()","createBoxes()","getOverlay(edge)","getConnection(overlay)","getRecursiveConnection(overlay)","connect(srcDiv,tgtDiv,connection)","plumbBoxes()"],"x":130,"y":130},{"names":["Dispatcher"],"attributes":["graph:Graph"],"methods":["init()","saveGraph()","loadGraph()","printGraph()","exportGraph()","updateGraph()","updateGraphCoords()","newDiagram()","share()","createAccount()","toggleAuthorship()"],"x":160,"y":160},{"names":["Graph"],"attributes":["vertices:[]","edges:[]","matrix:[]","font-size:number","padding:number"],"methods":[],"x":190,"y":190},{"names":["Vertex"],"attributes":["x:number","y:number","stereotype:string","name:string","attributes:[]","methods:[]"],"methods":[],"x":220,"y":220},{"names":["Edge"],"attributes":["left:string","right:string","type:string","leftMult:string","rightMult:string","role:string"],"methods":[],"x":250,"y":250},{"names":["Language"],"attributes":["ELEMENT_PHRASE:RegExp","RELATIONSHIP_PHRASE:RegExp","STEREOTYPE_WORD:RegExp","NAME_WORD:RegExp","ATTRIBUTE_WORD:RegExp","METHOD_WORD:RegExp","END_WORD:RegExp","MULT_WORD:RegExp","END_NAME_WORD:RegExp","REL_TYPE_WORD:RegExp","REL_TYPE_NAMES_WORD:RegExp"],"methods":[],"x":280,"y":280},{"names":["<<DOM>>","text_area"],"attributes":[],"methods":[],"x":310,"y":310},{"names":["<<DOM>>","drawing_panel"],"attributes":[],"methods":[],"x":340,"y":340},{"names":["<<server>>","Server"],"attributes":[],"methods":[],"x":370,"y":370}],"edges":[{"left":"Dispatcher","right":"Reader","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"Writer","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"Assimilator","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"Painter","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"Graph","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Graph","right":"Vertex","type":"hasa","leftMult":"1","rightMult":"0..*","role":""},{"left":"Graph","right":"Edge","type":"hasa","leftMult":"1","rightMult":"0..*","role":""},{"left":"Dispatcher","right":"Language","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"text_area","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"drawing_panel","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"Server","type":"hasa","leftMult":"1","rightMult":"1","role":""}],"matrix":[[1,0,0,0,0,-1,0,0,0,0,0,0,0],[0,1,0,0,0,-1,0,0,0,0,0,0,0],[0,0,1,0,0,-1,0,0,0,0,0,0,0],[0,0,0,0,1,-1,0,0,0,0,0,0,0],[0,0,0,0,0,-1,1,0,0,0,0,0,0],[0,0,0,0,0,0,-1,1,0,0,0,0,0],[0,0,0,0,0,0,-1,0,1,0,0,0,0],[0,0,0,0,0,-1,0,0,0,1,0,0,0],[0,0,0,0,0,-1,0,0,0,0,1,0,0],[0,0,0,0,0,-1,0,0,0,0,0,1,0],[0,0,0,0,0,-1,0,0,0,0,0,0,1]],"fontSize":18}';
        $this->updated_untangled = '{"title":"untangled","id":1,"version":2,"shared":true,"vertices":[{"names":["Reader"],"attributes":["lang:Language","graph:Graph","offset:10"],"methods":["read(g)","getText()","getElements()","getRelationships()","addToMatrix()","matchPhrase()","matchWord()","matchWords()"],"x":10,"y":10},{"names":["Writer"],"attributes":["graph:Graph"],"methods":["write(g)","parseGraph()","writeElements(v)","writeRels(edges,matrix)","writeRel(edge)","writeToEditor(param)","clearEditor()"],"x":40,"y":40},{"names":["Assimilator"],"attributes":["newG:Graph","oldGraph:Graph","assimGraph:Graph"],"methods":["assim(oldGraph,newGraph)","updateVertices(oldVs,newVs)"],"x":70,"y":70},{"names":["Highlighter"],"attributes":["names:[]","language:Language"],"methods":["highlight()","stripOldHighlights()","highlightIdentifiers()","getNames()","highlightNames()"],"x":100,"y":100},{"names":["Painter"],"attributes":["graph:Graph","isa:[]","hasa:[]","aggr:[]","comp:[]","boxes:[]"],"methods":["paint(g)","setupJSPlumb()","createBoxes()","getOverlay(edge)","getConnection(overlay)","getRecursiveConnection(overlay)","connect(srcDiv,tgtDiv,connection)","plumbBoxes()"],"x":130,"y":130},{"names":["Dispatcher"],"attributes":["graph:Graph"],"methods":["init()","saveGraph()","loadGraph()","printGraph()","exportGraph()","updateGraph()","updateGraphCoords()","newDiagram()","share()","createAccount()","toggleAuthorship()"],"x":160,"y":160},{"names":["Graph"],"attributes":["vertices:[]","edges:[]","matrix:[]","font-size:number","padding:number"],"methods":[],"x":190,"y":190},{"names":["Vertex"],"attributes":["x:number","y:number","stereotype:string","name:string","attributes:[]","methods:[]"],"methods":[],"x":220,"y":220},{"names":["Edge"],"attributes":["left:string","right:string","type:string","leftMult:string","rightMult:string","role:string"],"methods":[],"x":250,"y":250},{"names":["Language"],"attributes":["ELEMENT_PHRASE:RegExp","RELATIONSHIP_PHRASE:RegExp","STEREOTYPE_WORD:RegExp","NAME_WORD:RegExp","ATTRIBUTE_WORD:RegExp","METHOD_WORD:RegExp","END_WORD:RegExp","MULT_WORD:RegExp","END_NAME_WORD:RegExp","REL_TYPE_WORD:RegExp","REL_TYPE_NAMES_WORD:RegExp"],"methods":[],"x":280,"y":280},{"names":["<<DOM>>","text_area"],"attributes":[],"methods":[],"x":310,"y":310},{"names":["<<DOM>>","drawing_panel"],"attributes":[],"methods":[],"x":340,"y":340},{"names":["<<server>>","Server"],"attributes":[],"methods":[],"x":370,"y":370}],"edges":[{"left":"Dispatcher","right":"Reader","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"Writer","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"Assimilator","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"Painter","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"Graph","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Graph","right":"Vertex","type":"hasa","leftMult":"1","rightMult":"0..*","role":""},{"left":"Graph","right":"Edge","type":"hasa","leftMult":"1","rightMult":"0..*","role":""},{"left":"Dispatcher","right":"Language","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"text_area","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"drawing_panel","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"Server","type":"hasa","leftMult":"1","rightMult":"1","role":""}],"matrix":[[1,0,0,0,0,-1,0,0,0,0,0,0,0],[0,1,0,0,0,-1,0,0,0,0,0,0,0],[0,0,1,0,0,-1,0,0,0,0,0,0,0],[0,0,0,0,1,-1,0,0,0,0,0,0,0],[0,0,0,0,0,-1,1,0,0,0,0,0,0],[0,0,0,0,0,0,-1,1,0,0,0,0,0],[0,0,0,0,0,0,-1,0,1,0,0,0,0],[0,0,0,0,0,-1,0,0,0,1,0,0,0],[0,0,0,0,0,-1,0,0,0,0,1,0,0],[0,0,0,0,0,-1,0,0,0,0,0,1,0],[0,0,0,0,0,-1,0,0,0,0,0,0,1]],"fontSize":18}';
        $this->mock_untangled = json_decode($this->untangled);
        $this->decoded_untangled = json_decode($this->untangled);
        $this->decoded_inserted_untangled = json_decode($this->inserted_untangled);
        $this->untangled_path = $this->file_path.'1.txt';

        $this->_ci->db->truncate('users');
        $this->_ci->tank_auth->create_user('tester','untangleduml@gmail.com','tester',false);
        $this->_ci->tank_auth->create_user('jason','jtcarpenter@gmail.com','jason',false);
        $this->_ci->tank_auth->create_user('marta','jasoncarpenter99@hotmail.com','marta',false);
        $this->_ci->tank_auth->login('tester','tester',true,true,true);

        delete_files($this->file_path);
        $this->_ci->db->truncate('diagram');
        
        $this->_ci->diagram_model->save_diagram($this->mock_untangled);
    }

    /**
     * tearDown
     *
     * Runs after every test
     */
    public function tearDown(){

        $this->mock_diagram = 'I am a diagram';
        $this->observer = '{"title":"observer","id":null,"version":0,"shared":true,"vertices":[{"names":["<<interface>>","Subject"],"attributes":[],"methods":["+attach()","+detach()","+notify()"],"x":10,"y":10},{"names":["<<interface>>","Observer"],"attributes":[],"methods":["+update()"],"x":40,"y":40},{"names":["ConcreteSubject"],"attributes":["-subjectState"],"methods":[],"x":70,"y":70},{"names":["ConcreteObserver"],"attributes":["-observerState"],"methods":["+update()"],"x":100,"y":100}],"edges":[{"left":"Subject","right":"Observer","type":"hasa","leftMult":"","rightMult":"","role":"notifies"},{"left":"ConcreteObserver","right":"ConcreteSubject","type":"hasa","leftMult":"","rightMult":"","role":"observes"},{"left":"ConcreteSubject","right":"Subject","type":"isa","leftMult":"","rightMult":"","role":""},{"left":"ConcreteObserver","right":"Observer","type":"isa","leftMult":"","rightMult":"","role":""}],"matrix":[[-1,1,0,0],[0,0,1,-1],[1,0,-1,0],[0,1,0,-1]],"fontSize":18}';
        $this->decoded_observer = json_decode($this->observer);

        //simplified version of application diagram for testing
        $this->untangled = '{"title":"untangled","id":null,"version":0,"shared":true,"vertices":[{"names":["Reader"],"attributes":["lang:Language","graph:Graph","offset:10"],"methods":["read(g)","getText()","getElements()","getRelationships()","addToMatrix()","matchPhrase()","matchWord()","matchWords()"],"x":10,"y":10},{"names":["Writer"],"attributes":["graph:Graph"],"methods":["write(g)","parseGraph()","writeElements(v)","writeRels(edges,matrix)","writeRel(edge)","writeToEditor(param)","clearEditor()"],"x":40,"y":40},{"names":["Assimilator"],"attributes":["newG:Graph","oldGraph:Graph","assimGraph:Graph"],"methods":["assim(oldGraph,newGraph)","updateVertices(oldVs,newVs)"],"x":70,"y":70},{"names":["Highlighter"],"attributes":["names:[]","language:Language"],"methods":["highlight()","stripOldHighlights()","highlightIdentifiers()","getNames()","highlightNames()"],"x":100,"y":100},{"names":["Painter"],"attributes":["graph:Graph","isa:[]","hasa:[]","aggr:[]","comp:[]","boxes:[]"],"methods":["paint(g)","setupJSPlumb()","createBoxes()","getOverlay(edge)","getConnection(overlay)","getRecursiveConnection(overlay)","connect(srcDiv,tgtDiv,connection)","plumbBoxes()"],"x":130,"y":130},{"names":["Dispatcher"],"attributes":["graph:Graph"],"methods":["init()","saveGraph()","loadGraph()","printGraph()","exportGraph()","updateGraph()","updateGraphCoords()","newDiagram()","share()","createAccount()","toggleAuthorship()"],"x":160,"y":160},{"names":["Graph"],"attributes":["vertices:[]","edges:[]","matrix:[]","font-size:number","padding:number"],"methods":[],"x":190,"y":190},{"names":["Vertex"],"attributes":["x:number","y:number","stereotype:string","name:string","attributes:[]","methods:[]"],"methods":[],"x":220,"y":220},{"names":["Edge"],"attributes":["left:string","right:string","type:string","leftMult:string","rightMult:string","role:string"],"methods":[],"x":250,"y":250},{"names":["Language"],"attributes":["ELEMENT_PHRASE:RegExp","RELATIONSHIP_PHRASE:RegExp","STEREOTYPE_WORD:RegExp","NAME_WORD:RegExp","ATTRIBUTE_WORD:RegExp","METHOD_WORD:RegExp","END_WORD:RegExp","MULT_WORD:RegExp","END_NAME_WORD:RegExp","REL_TYPE_WORD:RegExp","REL_TYPE_NAMES_WORD:RegExp"],"methods":[],"x":280,"y":280},{"names":["<<DOM>>","text_area"],"attributes":[],"methods":[],"x":310,"y":310},{"names":["<<DOM>>","drawing_panel"],"attributes":[],"methods":[],"x":340,"y":340},{"names":["<<server>>","Server"],"attributes":[],"methods":[],"x":370,"y":370}],"edges":[{"left":"Dispatcher","right":"Reader","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"Writer","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"Assimilator","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"Painter","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"Graph","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Graph","right":"Vertex","type":"hasa","leftMult":"1","rightMult":"0..*","role":""},{"left":"Graph","right":"Edge","type":"hasa","leftMult":"1","rightMult":"0..*","role":""},{"left":"Dispatcher","right":"Language","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"text_area","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"drawing_panel","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"Server","type":"hasa","leftMult":"1","rightMult":"1","role":""}],"matrix":[[1,0,0,0,0,-1,0,0,0,0,0,0,0],[0,1,0,0,0,-1,0,0,0,0,0,0,0],[0,0,1,0,0,-1,0,0,0,0,0,0,0],[0,0,0,0,1,-1,0,0,0,0,0,0,0],[0,0,0,0,0,-1,1,0,0,0,0,0,0],[0,0,0,0,0,0,-1,1,0,0,0,0,0],[0,0,0,0,0,0,-1,0,1,0,0,0,0],[0,0,0,0,0,-1,0,0,0,1,0,0,0],[0,0,0,0,0,-1,0,0,0,0,1,0,0],[0,0,0,0,0,-1,0,0,0,0,0,1,0],[0,0,0,0,0,-1,0,0,0,0,0,0,1]],"fontSize":18}';
        $this->inserted_untangled = '{"title":"untangled","id":1,"version":1,"shared":true,"vertices":[{"names":["Reader"],"attributes":["lang:Language","graph:Graph","offset:10"],"methods":["read(g)","getText()","getElements()","getRelationships()","addToMatrix()","matchPhrase()","matchWord()","matchWords()"],"x":10,"y":10},{"names":["Writer"],"attributes":["graph:Graph"],"methods":["write(g)","parseGraph()","writeElements(v)","writeRels(edges,matrix)","writeRel(edge)","writeToEditor(param)","clearEditor()"],"x":40,"y":40},{"names":["Assimilator"],"attributes":["newG:Graph","oldGraph:Graph","assimGraph:Graph"],"methods":["assim(oldGraph,newGraph)","updateVertices(oldVs,newVs)"],"x":70,"y":70},{"names":["Highlighter"],"attributes":["names:[]","language:Language"],"methods":["highlight()","stripOldHighlights()","highlightIdentifiers()","getNames()","highlightNames()"],"x":100,"y":100},{"names":["Painter"],"attributes":["graph:Graph","isa:[]","hasa:[]","aggr:[]","comp:[]","boxes:[]"],"methods":["paint(g)","setupJSPlumb()","createBoxes()","getOverlay(edge)","getConnection(overlay)","getRecursiveConnection(overlay)","connect(srcDiv,tgtDiv,connection)","plumbBoxes()"],"x":130,"y":130},{"names":["Dispatcher"],"attributes":["graph:Graph"],"methods":["init()","saveGraph()","loadGraph()","printGraph()","exportGraph()","updateGraph()","updateGraphCoords()","newDiagram()","share()","createAccount()","toggleAuthorship()"],"x":160,"y":160},{"names":["Graph"],"attributes":["vertices:[]","edges:[]","matrix:[]","font-size:number","padding:number"],"methods":[],"x":190,"y":190},{"names":["Vertex"],"attributes":["x:number","y:number","stereotype:string","name:string","attributes:[]","methods:[]"],"methods":[],"x":220,"y":220},{"names":["Edge"],"attributes":["left:string","right:string","type:string","leftMult:string","rightMult:string","role:string"],"methods":[],"x":250,"y":250},{"names":["Language"],"attributes":["ELEMENT_PHRASE:RegExp","RELATIONSHIP_PHRASE:RegExp","STEREOTYPE_WORD:RegExp","NAME_WORD:RegExp","ATTRIBUTE_WORD:RegExp","METHOD_WORD:RegExp","END_WORD:RegExp","MULT_WORD:RegExp","END_NAME_WORD:RegExp","REL_TYPE_WORD:RegExp","REL_TYPE_NAMES_WORD:RegExp"],"methods":[],"x":280,"y":280},{"names":["<<DOM>>","text_area"],"attributes":[],"methods":[],"x":310,"y":310},{"names":["<<DOM>>","drawing_panel"],"attributes":[],"methods":[],"x":340,"y":340},{"names":["<<server>>","Server"],"attributes":[],"methods":[],"x":370,"y":370}],"edges":[{"left":"Dispatcher","right":"Reader","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"Writer","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"Assimilator","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"Painter","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"Graph","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Graph","right":"Vertex","type":"hasa","leftMult":"1","rightMult":"0..*","role":""},{"left":"Graph","right":"Edge","type":"hasa","leftMult":"1","rightMult":"0..*","role":""},{"left":"Dispatcher","right":"Language","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"text_area","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"drawing_panel","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"Server","type":"hasa","leftMult":"1","rightMult":"1","role":""}],"matrix":[[1,0,0,0,0,-1,0,0,0,0,0,0,0],[0,1,0,0,0,-1,0,0,0,0,0,0,0],[0,0,1,0,0,-1,0,0,0,0,0,0,0],[0,0,0,0,1,-1,0,0,0,0,0,0,0],[0,0,0,0,0,-1,1,0,0,0,0,0,0],[0,0,0,0,0,0,-1,1,0,0,0,0,0],[0,0,0,0,0,0,-1,0,1,0,0,0,0],[0,0,0,0,0,-1,0,0,0,1,0,0,0],[0,0,0,0,0,-1,0,0,0,0,1,0,0],[0,0,0,0,0,-1,0,0,0,0,0,1,0],[0,0,0,0,0,-1,0,0,0,0,0,0,1]],"fontSize":18}';
        $this->updated_untangled = '{"title":"untangled","id":1,"version":2,"shared":true,"vertices":[{"names":["Reader"],"attributes":["lang:Language","graph:Graph","offset:10"],"methods":["read(g)","getText()","getElements()","getRelationships()","addToMatrix()","matchPhrase()","matchWord()","matchWords()"],"x":10,"y":10},{"names":["Writer"],"attributes":["graph:Graph"],"methods":["write(g)","parseGraph()","writeElements(v)","writeRels(edges,matrix)","writeRel(edge)","writeToEditor(param)","clearEditor()"],"x":40,"y":40},{"names":["Assimilator"],"attributes":["newG:Graph","oldGraph:Graph","assimGraph:Graph"],"methods":["assim(oldGraph,newGraph)","updateVertices(oldVs,newVs)"],"x":70,"y":70},{"names":["Highlighter"],"attributes":["names:[]","language:Language"],"methods":["highlight()","stripOldHighlights()","highlightIdentifiers()","getNames()","highlightNames()"],"x":100,"y":100},{"names":["Painter"],"attributes":["graph:Graph","isa:[]","hasa:[]","aggr:[]","comp:[]","boxes:[]"],"methods":["paint(g)","setupJSPlumb()","createBoxes()","getOverlay(edge)","getConnection(overlay)","getRecursiveConnection(overlay)","connect(srcDiv,tgtDiv,connection)","plumbBoxes()"],"x":130,"y":130},{"names":["Dispatcher"],"attributes":["graph:Graph"],"methods":["init()","saveGraph()","loadGraph()","printGraph()","exportGraph()","updateGraph()","updateGraphCoords()","newDiagram()","share()","createAccount()","toggleAuthorship()"],"x":160,"y":160},{"names":["Graph"],"attributes":["vertices:[]","edges:[]","matrix:[]","font-size:number","padding:number"],"methods":[],"x":190,"y":190},{"names":["Vertex"],"attributes":["x:number","y:number","stereotype:string","name:string","attributes:[]","methods:[]"],"methods":[],"x":220,"y":220},{"names":["Edge"],"attributes":["left:string","right:string","type:string","leftMult:string","rightMult:string","role:string"],"methods":[],"x":250,"y":250},{"names":["Language"],"attributes":["ELEMENT_PHRASE:RegExp","RELATIONSHIP_PHRASE:RegExp","STEREOTYPE_WORD:RegExp","NAME_WORD:RegExp","ATTRIBUTE_WORD:RegExp","METHOD_WORD:RegExp","END_WORD:RegExp","MULT_WORD:RegExp","END_NAME_WORD:RegExp","REL_TYPE_WORD:RegExp","REL_TYPE_NAMES_WORD:RegExp"],"methods":[],"x":280,"y":280},{"names":["<<DOM>>","text_area"],"attributes":[],"methods":[],"x":310,"y":310},{"names":["<<DOM>>","drawing_panel"],"attributes":[],"methods":[],"x":340,"y":340},{"names":["<<server>>","Server"],"attributes":[],"methods":[],"x":370,"y":370}],"edges":[{"left":"Dispatcher","right":"Reader","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"Writer","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"Assimilator","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"Painter","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"Graph","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Graph","right":"Vertex","type":"hasa","leftMult":"1","rightMult":"0..*","role":""},{"left":"Graph","right":"Edge","type":"hasa","leftMult":"1","rightMult":"0..*","role":""},{"left":"Dispatcher","right":"Language","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"text_area","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"drawing_panel","type":"hasa","leftMult":"1","rightMult":"1","role":""},{"left":"Dispatcher","right":"Server","type":"hasa","leftMult":"1","rightMult":"1","role":""}],"matrix":[[1,0,0,0,0,-1,0,0,0,0,0,0,0],[0,1,0,0,0,-1,0,0,0,0,0,0,0],[0,0,1,0,0,-1,0,0,0,0,0,0,0],[0,0,0,0,1,-1,0,0,0,0,0,0,0],[0,0,0,0,0,-1,1,0,0,0,0,0,0],[0,0,0,0,0,0,-1,1,0,0,0,0,0],[0,0,0,0,0,0,-1,0,1,0,0,0,0],[0,0,0,0,0,-1,0,0,0,1,0,0,0],[0,0,0,0,0,-1,0,0,0,0,1,0,0],[0,0,0,0,0,-1,0,0,0,0,0,1,0],[0,0,0,0,0,-1,0,0,0,0,0,0,1]],"fontSize":18}';
        $this->mock_untangled = json_decode($this->untangled);
        $this->decoded_untangled = json_decode($this->untangled);
        $this->decoded_inserted_untangled = json_decode($this->inserted_untangled);
        $this->untangled_path = $this->file_path.'1.txt';

        delete_files($this->file_path);
        $this->_ci->db->truncate('diagram');

        //initialise application diagrams for demonstration
        $this->_ci->diagram_model->save_diagram(json_decode($this->untangled_analysis));      
        $this->_ci->diagram_model->save_diagram(json_decode($this->server_analysis));
        $this->_ci->diagram_model->save_diagram(json_decode($this->untangled_design));
        $this->_ci->diagram_model->save_diagram(json_decode($this->editor_controller));
        $this->_ci->diagram_model->save_diagram(json_decode($this->sharing_controller));
        $this->_ci->diagram_model->save_diagram(json_decode($this->accounts_controller));
        $this->_ci->diagram_model->save_diagram(json_decode($this->documentation_controller));
    }

    public function test_insert_diagram(){
        $this->_ci->db->truncate('diagram');
        $insert1 = $this->_ci->diagram_model->insert_diagram($this->user_id,'untitled',1,true);
        $insert2 = $this->_ci->diagram_model->insert_diagram($this->user_id,'titled',1,true);
        
        $this->assertIdentical($insert1,1,'inserted diagram with diagram_id '.$insert1);
        $this->assertEqual($insert2,2,'inserted diagram with diagram_id '.$insert2);
    }

    public function test_update_diagram(){
        $update = $this->_ci->diagram_model->update_diagram(1,$this->user_id,'titled',2,true);

        $this->assertTrue($update,'updated diagram');
    }

    public function test_write_diagram(){
        $path = $this->file_path.'1'.'.txt';
        $this->_ci->diagram_model->write_diagram(1,$this->mock_diagram);
        $string = read_file($path);

        $this->assertEqual($string,'I am a diagram','created a file containing diagram');

        $this->_ci->diagram_model->write_diagram(1,'I am an updated diagram');
        $string = read_file($path);

        $this->assertEqual($string,'I am an updated diagram','file already existed with this diagram_is so overwrote contents');

        unlink($path);
    }

    public function test_save_diagram(){
        $this->_ci->db->truncate('diagram');
        delete_files($this->file_path);
        
        $path = $this->file_path.'1'.'.txt';
        $this->_ci->diagram_model->save_diagram($this->decoded_untangled);
        $string = read_file($path);

        $this->assertEqual($string,$this->inserted_untangled,'saved a new diagram to db and file');

        $this->_ci->diagram_model->save_diagram($this->decoded_inserted_untangled);
        $string = read_file($path);

        $this->assertEqual($string,$this->updated_untangled,'updated diagram, version number in file has been incremented');
    }

    public function test_get_user_diagrams(){
        $this->_ci->diagram_model->save_diagram($this->decoded_observer);
        $diagrams = $this->_ci->diagram_model->get_user_diagrams();
        $last = count($diagrams)-1;
        
        $this->assertEqual($diagrams[0]->title,'untangled','returned array of diagrams, first diagram has expected title');
        $this->assertEqual($diagrams[0]->shared,true,'first diagram is shared');
        $this->assertEqual($diagrams[$last]->title,'observer','second diagram has expected title');
    }

    public function test_get_diagram_str(){
        $diagram_str = $this->_ci->diagram_model->get_diagram_str(1);

        $this->assertEqual($diagram_str,$this->inserted_untangled,'returned diagram str for passed diagram_id');
    }

    public function test_get_diagram(){
        $diagram = $this->_ci->diagram_model->get_diagram(1);

        $this->assertEqual($diagram,$this->mock_untangled,'returned diagram for passed diagram_id');
    }

    public function test_get_shared_diagrams(){
        $sharer = 2;
        $this->_ci->diagram_model->insert_diagram(2,'public shared',1,true);
        $this->_ci->diagram_model->insert_diagram(3,'public not shared ',1,true);
        $this->_ci->diagram_model->insert_diagram(2,'not public',1,false);
        $this->_ci->diagram_model->insert_diagram(2,'public shared',1,true);
        
        $diagrams = $this->_ci->diagram_model->get_shared_diagrams($sharer);
        $id_arr = array();
        foreach($diagrams as $diagram)$id_arr[] = $diagram->user_id;

        $this->assertEqual(sizeOf($diagrams),2,sizeOf($diagrams).'returned expected number of public diagrams');
        $this->assertEqual($diagrams[0]->title,'public shared','first shared diagram not owned');
        $this->assertFalse(in_array($this->user_id,$id_arr),'none of the returned diagrams are owned by the current user');
    }

    public function test_diagram_exists(){
        $this->_ci->diagram_model->insert_diagram(5,'shared diagram',1,true);

        $id = $this->_ci->diagram_model->diagram_exists(1);
        $this->assertEqual($id,1,'returns user id of auther of this graph');

        $id = $this->_ci->diagram_model->diagram_exists(2);
        $this->assertEqual($id,5,'returns user id of auther of this graph');

        $id = $this->_ci->diagram_model->diagram_exists(3);
        $this->assertFalse($id,'returns false, there is no diagram with this id');
    }

    public function test_delete_diagram(){
        $this->_ci->diagram_model->insert_diagram($this->user_id,'titled',1,true);
        $delete = $this->_ci->diagram_model->delete_diagram(1);

        $this->assertTrue($delete,'diagram deleted from database');
    }
}